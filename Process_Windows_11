import psutil
import time
import ctypes
from ctypes import wintypes
import threading
import queue
from datetime import datetime
import tkinter as tk
from tkinter import ttk, scrolledtext, messagebox
import os
import sys


class ProcessMonitorGUI:
    def __init__(self, root):
        self.root = root
        self.root.title("Windows 11 Process Monitor")
        self.root.geometry("1300x750")

        # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        self.active_pid = None
        self.running = True
        self.paused = False
        self.update_interval = 1000  # –º—Å

        # –û—á–µ—Ä–µ–¥–∏ –¥–ª—è –º–µ–∂–ø–æ—Ç–æ—á–Ω–æ–π –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
        self.process_queue = queue.Queue(maxsize=100)
        self.active_pid_queue = queue.Queue(maxsize=10)

        # –ö—ç—à –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
        self.processes = {}

        # –°–µ–º–∞—Ñ–æ—Ä –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        self.update_lock = threading.Lock()

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç–∏–ª–µ–π
        self.setup_styles()

        # –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        self.create_widgets()

        # –ó–∞–ø—É—Å–∫ —Ä–∞–±–æ—á–∏—Ö –ø–æ—Ç–æ–∫–æ–≤
        self.start_worker_threads()

        # –ó–∞–ø—É—Å–∫ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        self.schedule_update()

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞
        self.root.protocol("WM_DELETE_WINDOW", self.on_closing)

        # –°—á–µ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        self.update_count = 0

    def setup_styles(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç–∏–ª–µ–π –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"""
        style = ttk.Style()
        style.theme_use('clam')

        # –¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞
        self.tree_colors = {
            'active': '#d4edda',  # –°–≤–µ—Ç–ª–æ-–∑–µ–ª–µ–Ω—ã–π –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
            'system': '#fff3cd',  # –°–≤–µ—Ç–ª–æ-–∂–µ–ª—Ç—ã–π –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö
            'high_cpu': '#f8d7da',  # –°–≤–µ—Ç–ª–æ-–∫—Ä–∞—Å–Ω—ã–π –¥–ª—è –≤—ã—Å–æ–∫–æ–≥–æ CPU
            'high_mem': '#ffeaa7',  # –°–≤–µ—Ç–ª–æ-–æ—Ä–∞–Ω–∂–µ–≤—ã–π –¥–ª—è –≤—ã—Å–æ–∫–æ–π –ø–∞–º—è—Ç–∏
            'normal': '#ffffff',  # –ë–µ–ª—ã–π –¥–ª—è –æ–±—ã—á–Ω—ã—Ö
        }

        # –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è Treeview
        style.configure('Treeview',
                        rowheight=25,
                        font=('Segoe UI', 10),
                        background='white',
                        fieldbackground='white')

        style.configure('Treeview.Heading',
                        font=('Segoe UI', 10, 'bold'),
                        background='#0078d7',
                        foreground='white')

        style.map('Treeview',
                  background=[('selected', '#0078d7')],
                  foreground=[('selected', 'white')])

    def create_widgets(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"""
        # –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å padding
        main_container = ttk.Frame(self.root, padding="5")
        main_container.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ—Å–æ–≤
        self.root.columnconfigure(0, weight=1)
        self.root.rowconfigure(0, weight=1)
        main_container.columnconfigure(0, weight=1)
        main_container.rowconfigure(3, weight=1)

        # –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å –∑–∞–≥–æ–ª–æ–≤–∫–∞
        header_frame = ttk.Frame(main_container)
        header_frame.grid(row=0, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        ttk.Label(header_frame,
                  text="üñ•Ô∏è Windows 11 Process Monitor",
                  font=('Segoe UI', 16, 'bold'),
                  foreground='#0078d7').pack(side=tk.LEFT)

        # –ü–∞–Ω–µ–ª—å –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
        quick_actions_frame = ttk.Frame(main_container)
        quick_actions_frame.grid(row=1, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        # –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
        action_buttons = [
            ("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", self.manual_update, '#28a745'),
            ("‚è∏Ô∏è –ü–∞—É–∑–∞", self.toggle_pause, '#ffc107'),
            ("üîç –ü–æ–∏—Å–∫", self.search_process, '#17a2b8'),
            ("‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å", self.kill_process, '#dc3545'),
            ("üìä –î–µ—Ç–∞–ª–∏", self.show_details, '#6f42c1'),
        ]

        for text, command, color in action_buttons:
            btn = tk.Button(quick_actions_frame,
                            text=text,
                            command=command,
                            bg=color,
                            fg='white',
                            font=('Segoe UI', 10),
                            relief='flat',
                            padx=12,
                            pady=6,
                            cursor='hand2')
            btn.pack(side=tk.LEFT, padx=3)
            btn.bind("<Enter>", lambda e, b=btn: b.configure(bg='#0056b3'))
            btn.bind("<Leave>", lambda e, b=btn, c=color: b.configure(bg=c))

        # –ü–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–∏—Å—Ç–µ–º–µ
        info_frame = ttk.LabelFrame(main_container, text="–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", padding="10")
        info_frame.grid(row=2, column=0, sticky=(tk.W, tk.E), pady=(0, 10))

        # –°–æ–∑–¥–∞–µ–º —Å–µ—Ç–∫—É –¥–ª—è –º–µ—Ç–æ–∫
        self.active_label = ttk.Label(info_frame, text="–ê–∫—Ç–∏–≤–Ω–æ–µ –æ–∫–Ω–æ: –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ")
        self.active_label.grid(row=0, column=0, sticky=tk.W, padx=10)

        self.stats_label = ttk.Label(info_frame, text="–ü—Ä–æ—Ü–µ—Å—Å–æ–≤: 0 | CPU: 0% | –ü–∞–º—è—Ç—å: 0 MB")
        self.stats_label.grid(row=0, column=1, sticky=tk.W, padx=10)

        self.time_label = ttk.Label(info_frame, text="–û–±–Ω–æ–≤–ª–µ–Ω–æ: --:--:--")
        self.time_label.grid(row=0, column=2, sticky=tk.W, padx=10)

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
        ttk.Label(info_frame, text="–ò–Ω—Ç–µ—Ä–≤–∞–ª (–º—Å):").grid(row=0, column=3, sticky=tk.W, padx=(20, 5))

        self.interval_var = tk.StringVar(value="1000")
        interval_combo = ttk.Combobox(info_frame,
                                      textvariable=self.interval_var,
                                      values=["250", "500", "1000", "2000", "3000"],
                                      width=8,
                                      state="readonly")
        interval_combo.grid(row=0, column=4, sticky=tk.W, padx=5)
        interval_combo.bind('<<ComboboxSelected>>', self.change_interval)

        # –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
        table_frame = ttk.LabelFrame(main_container, text="–°–ø–∏—Å–æ–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤", padding="5")
        table_frame.grid(row=3, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))
        table_frame.columnconfigure(0, weight=1)
        table_frame.rowconfigure(0, weight=1)

        # –°–æ–∑–¥–∞–Ω–∏–µ Treeview
        columns = ('PID', '–ò–º—è –ø—Ä–æ—Ü–µ—Å—Å–∞', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', 'CPU %', '–ü–∞–º—è—Ç—å (MB)',
                   '–ü–æ—Ç–æ–∫–∏', '–°–æ—Å—Ç–æ—è–Ω–∏–µ', '–í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞')

        self.tree = ttk.Treeview(table_frame, columns=columns, show='headings', height=18)

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–ª–æ–Ω–æ–∫ —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏
        col_configs = [
            ('PID', 70),
            ('–ò–º—è –ø—Ä–æ—Ü–µ—Å—Å–∞', 250),
            ('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', 120),
            ('CPU %', 70),
            ('–ü–∞–º—è—Ç—å (MB)', 100),
            ('–ü–æ—Ç–æ–∫–∏', 70),
            ('–°–æ—Å—Ç–æ—è–Ω–∏–µ', 90),
            ('–í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞', 130),
        ]

        for col, width in col_configs:
            self.tree.heading(col, text=col)
            self.tree.column(col, width=width, minwidth=50, anchor='center')

        # –ü–æ–ª–æ—Å—ã –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        v_scrollbar = ttk.Scrollbar(table_frame, orient=tk.VERTICAL, command=self.tree.yview)
        h_scrollbar = ttk.Scrollbar(table_frame, orient=tk.HORIZONTAL, command=self.tree.xview)
        self.tree.configure(yscrollcommand=v_scrollbar.set, xscrollcommand=h_scrollbar.set)

        # –†–∞–∑–º–µ—â–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ç–∞–±–ª–∏—Ü—ã
        self.tree.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))
        v_scrollbar.grid(row=0, column=1, sticky=(tk.N, tk.S))
        h_scrollbar.grid(row=1, column=0, sticky=(tk.W, tk.E))

        # –ü–∞–Ω–µ–ª—å –¥–µ—Ç–∞–ª–µ–π –ø—Ä–æ—Ü–µ—Å—Å–∞
        detail_frame = ttk.LabelFrame(main_container, text="–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", padding="10")
        detail_frame.grid(row=4, column=0, sticky=(tk.W, tk.E), pady=(10, 0))

        self.detail_text = scrolledtext.ScrolledText(detail_frame,
                                                     height=5,
                                                     wrap=tk.WORD,
                                                     font=('Consolas', 9))
        self.detail_text.pack(fill=tk.BOTH, expand=True)

        # –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π
        self.tree.bind('<<TreeviewSelect>>', self.on_process_select)
        self.tree.bind('<Double-Button-1>', self.show_process_details)

        # –°—Ç–∞—Ç—É—Å –±–∞—Ä –≤–Ω–∏–∑—É –æ–∫–Ω–∞
        self.status_var = tk.StringVar(value="–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ")
        status_bar = ttk.Label(main_container,
                               textvariable=self.status_var,
                               relief=tk.SUNKEN,
                               anchor=tk.W,
                               font=('Segoe UI', 9))
        status_bar.grid(row=5, column=0, sticky=(tk.W, tk.E), pady=(10, 0))

    def start_worker_threads(self):
        """–ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤—ã—Ö –ø–æ—Ç–æ–∫–æ–≤ –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö"""
        # –ü–æ—Ç–æ–∫ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–∫–Ω–∞
        self.active_monitor_thread = threading.Thread(
            target=self.monitor_active_window,
            daemon=True,
            name="ActiveWindowMonitor"
        )
        self.active_monitor_thread.start()

        # –ü–æ—Ç–æ–∫ –¥–ª—è —Å–±–æ—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö
        self.process_collector_thread = threading.Thread(
            target=self.collect_processes,
            daemon=True,
            name="ProcessCollector"
        )
        self.process_collector_thread.start()

    def monitor_active_window(self):
        """–§–æ–Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–∫–Ω–∞"""
        while self.running:
            try:
                if not self.paused:
                    pid = self.get_active_window()
                    if pid is not None:
                        try:
                            self.active_pid_queue.put_nowait(pid)
                        except queue.Full:
                            pass  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å –ø–æ–ª–Ω–∞—è
                time.sleep(0.1)  # –ß–∞—Å—Ç–æ—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ 10 –ì—Ü
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –≤ –º–æ–Ω–∏—Ç–æ—Ä–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–∫–Ω–∞: {e}")
                time.sleep(1)

    def collect_processes(self):
        """–§–æ–Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫ –¥–ª—è —Å–±–æ—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö"""
        batch_size = 50  # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ 50 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∑–∞ —Ä–∞–∑
        last_full_update = 0

        while self.running:
            try:
                if self.paused:
                    time.sleep(0.5)
                    continue

                current_time = time.time()

                # –ü–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
                if current_time - last_full_update > 2.0:
                    self.update_status("–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö...")
                    processes_batch = []

                    # –ë—ã—Å—Ç—Ä–æ —Å–æ–±–∏—Ä–∞–µ–º –≤—Å–µ PID
                    try:
                        all_pids = psutil.pids()[:200]  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
                    except:
                        time.sleep(1)
                        continue

                    # –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ—Ä—Ü–∏—è–º–∏
                    for i, pid in enumerate(all_pids):
                        if not self.running or self.paused:
                            break

                        try:
                            proc_info = self.get_quick_process_info(pid)
                            if proc_info:
                                processes_batch.append(proc_info)
                        except (psutil.NoSuchProcess, psutil.AccessDenied):
                            continue

                        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ—Ä—Ü–∏—è–º–∏ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
                        if len(processes_batch) >= batch_size or i == len(all_pids) - 1:
                            if processes_batch:
                                try:
                                    self.process_queue.put_nowait(('batch', processes_batch.copy()))
                                except queue.Full:
                                    pass
                                processes_batch.clear()

                    last_full_update = current_time
                    self.update_status("–î–∞–Ω–Ω—ã–µ —Å–æ–±—Ä–∞–Ω—ã")

                time.sleep(0.1)  # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É —Ü–∏–∫–ª–∞–º–∏

            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –≤ —Å–±–æ—Ä—â–∏–∫–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤: {e}")
                time.sleep(1)

    def get_active_window(self):
        """–ë—ã—Å—Ç—Ä–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ PID –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–∫–Ω–∞"""
        try:
            user32 = ctypes.windll.user32
            hwnd = user32.GetForegroundWindow()
            if hwnd:
                pid = wintypes.DWORD()
                user32.GetWindowThreadProcessId(hwnd, ctypes.byref(pid))
                return pid.value
        except:
            pass
        return None

    def get_quick_process_info(self, pid):
        """–ë—ã—Å—Ç—Ä–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ"""
        try:
            with self.update_lock:
                process = psutil.Process(pid)

                # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
                info = {
                    'pid': pid,
                    'name': process.name(),
                    'cpu_percent': process.cpu_percent(interval=0),
                    'memory_mb': process.memory_info().rss / 1048576,
                    'threads': process.num_threads(),
                    'status': process.status(),
                }

                # –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–æ–π)
                try:
                    username = process.username()
                    if username and '\\' in username:
                        username = username.split('\\')[-1]
                    info['username'] = username[:15] if username else 'SYSTEM'
                    info['is_system'] = 'SYSTEM' in (username or '').upper()
                except:
                    info['username'] = 'N/A'
                    info['is_system'] = False

                # –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è
                try:
                    info['create_time'] = datetime.fromtimestamp(
                        process.create_time()
                    ).strftime('%H:%M:%S')
                except:
                    info['create_time'] = 'N/A'

                return info

        except (psutil.NoSuchProcess, psutil.AccessDenied, psutil.ZombieProcess):
            return None

    def schedule_update(self):
        """–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è GUI –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞"""
        if not self.running:
            return

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∞–∫—Ç–∏–≤–Ω–æ–≥–æ PID
        try:
            while True:
                pid = self.active_pid_queue.get_nowait()
                self.active_pid = pid
                self.update_active_label(pid)
        except queue.Empty:
            pass

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
        try:
            while True:
                msg_type, data = self.process_queue.get_nowait()
                if msg_type == 'batch' and not self.paused:
                    self.processes.update({p['pid']: p for p in data})
                    self.update_treeview()
                    self.update_statistics()
                    self.update_count += 1
        except queue.Empty:
            pass

        # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
        current_time = datetime.now().strftime('%H:%M:%S')
        self.time_label.config(text=f"–û–±–Ω–æ–≤–ª–µ–Ω–æ: {current_time}")

        # –ü–ª–∞–Ω–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        self.root.after(100, self.schedule_update)  # –ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è GUI 10 –ì—Ü

    def update_active_label(self, pid):
        """–û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–∫—É –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–∫–Ω–∞"""
        if pid:
            proc = self.processes.get(pid)
            if proc:
                self.active_label.config(
                    text=f"–ê–∫—Ç–∏–≤–Ω–æ–µ –æ–∫–Ω–æ: PID {pid} ({proc['name']})"
                )
            else:
                self.active_label.config(
                    text=f"–ê–∫—Ç–∏–≤–Ω–æ–µ –æ–∫–Ω–æ: PID {pid}"
                )

    def update_treeview(self):
        """–û–±–Ω–æ–≤–∏—Ç—å Treeview —Å –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ)"""
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —á–∞—Å—Ç–æ—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π Treeview
        if not hasattr(self, '_last_tree_update'):
            self._last_tree_update = 0

        current_time = time.time()
        if current_time - self._last_tree_update < 0.5:  # –ù–µ —á–∞—â–µ 2 –ì—Ü
            return

        self._last_tree_update = current_time

        try:
            # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            selection = self.tree.selection()
            selected_pid = None
            if selection:
                item = self.tree.item(selection[0])
                selected_pid = item['values'][0] if item['values'] else None

            # –û—á–∏—â–∞–µ–º Treeview
            self.tree.delete(*self.tree.get_children())

            # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –ø–æ CPU
            sorted_procs = sorted(self.processes.values(),
                                  key=lambda x: x.get('cpu_percent', 0),
                                  reverse=True)

            # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –≤ Treeview —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º
            for proc in sorted_procs[:100]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ–ø-100
                values = (
                    proc['pid'],
                    proc['name'][:40],
                    proc.get('username', 'N/A')[:15],
                    f"{proc.get('cpu_percent', 0):.1f}",
                    f"{proc.get('memory_mb', 0):.1f}",
                    proc.get('threads', 0),
                    proc.get('status', 'N/A'),
                    proc.get('create_time', 'N/A'),
                )

                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–≥–∏ –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
                tags = []
                if proc['pid'] == self.active_pid:
                    tags.append('active')
                if proc.get('is_system', False):
                    tags.append('system')
                if proc.get('cpu_percent', 0) > 30:
                    tags.append('high_cpu')
                if proc.get('memory_mb', 0) > 200:
                    tags.append('high_mem')

                if not tags:
                    tags.append('normal')

                # –í—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É
                item_id = self.tree.insert('', 'end', values=values, tags=tags)

                # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ü–≤–µ—Ç–∞ –¥–ª—è —Ç–µ–≥–æ–≤
                for tag in tags:
                    color = self.tree_colors.get(tag, '#ffffff')
                    self.tree.tag_configure(tag, background=color)

            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            if selected_pid:
                for child in self.tree.get_children():
                    item_values = self.tree.item(child)['values']
                    if item_values and item_values[0] == selected_pid:
                        self.tree.selection_set(child)
                        self.tree.see(child)
                        break

            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            self.status_var.set(f"–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è {len(sorted_procs[:100])} –∏–∑ {len(sorted_procs)} –ø—Ä–æ—Ü–µ—Å—Å–æ–≤")

        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ Treeview: {e}")

    def update_statistics(self):
        """–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ)"""
        try:
            total = len(self.processes)
            if total == 0:
                return

            # –ë—ã—Å—Ç—Ä—ã–π —Ä–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            total_cpu = 0
            total_memory = 0
            system_count = 0

            for proc in self.processes.values():
                total_cpu += proc.get('cpu_percent', 0)
                total_memory += proc.get('memory_mb', 0)
                if proc.get('is_system', False):
                    system_count += 1

            self.stats_label.config(
                text=f"–ü—Ä–æ—Ü–µ—Å—Å–æ–≤: {total} | "
                     f"–°–∏—Å—Ç–µ–º–Ω—ã—Ö: {system_count} | "
                     f"CPU: {total_cpu:.1f}% | "
                     f"–ü–∞–º—è—Ç—å: {total_memory:.1f} MB"
            )

        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")

    def update_status(self, message):
        """–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å–Ω—É—é —Å—Ç—Ä–æ–∫—É –∏–∑ —Ñ–æ–Ω–æ–≤–æ–≥–æ –ø–æ—Ç–æ–∫–∞"""

        def update():
            self.status_var.set(message)

        self.root.after(0, update)

    def on_process_select(self, event):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ"""
        selection = self.tree.selection()
        if not selection:
            return

        item = self.tree.item(selection[0])
        values = item['values']

        if values:
            pid = values[0]
            proc = self.processes.get(pid)

            if proc:
                detail_text = f"""
PID: {proc['pid']}
–ò–º—è –ø—Ä–æ—Ü–µ—Å—Å–∞: {proc['name']}
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {proc.get('username', 'N/A')}
CPU: {proc.get('cpu_percent', 0):.1f}%
–ü–∞–º—è—Ç—å: {proc.get('memory_mb', 0):.1f} MB
–ü–æ—Ç–æ–∫–∏: {proc.get('threads', 0)}
–°–æ—Å—Ç–æ—è–Ω–∏–µ: {proc.get('status', 'N/A')}
–í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞: {proc.get('create_time', 'N/A')}
–¢–∏–ø: {'–°–∏—Å—Ç–µ–º–Ω—ã–π' if proc.get('is_system', False) else '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π'}
                """

                self.detail_text.delete(1.0, tk.END)
                self.detail_text.insert(1.0, detail_text.strip())

    def show_process_details(self, event):
        """–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ"""
        selection = self.tree.selection()
        if not selection:
            return

        item = self.tree.item(selection[0])
        pid = item['values'][0]

        # –ó–∞–ø—É—Å–∫–∞–µ–º –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∑–∞–≤–∏—Å–∞–Ω–∏—è
        thread = threading.Thread(
            target=self.load_detailed_info,
            args=(pid,),
            daemon=True
        )
        thread.start()

    def load_detailed_info(self, pid):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ (–≤ —Ñ–æ–Ω–µ)"""
        try:
            process = psutil.Process(pid)

            # –°–æ–±–∏—Ä–∞–µ–º –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            info = {
                'pid': pid,
                'name': process.name(),
                'exe': process.exe() or 'N/A',
                'cmdline': ' '.join(process.cmdline()) if process.cmdline() else 'N/A',
                'username': process.username() or 'N/A',
                'cpu_percent': process.cpu_percent(interval=0.1),
                'memory_percent': process.memory_percent(),
                'memory_mb': process.memory_info().rss / 1048576,
                'threads': process.num_threads(),
                'status': process.status(),
                'create_time': datetime.fromtimestamp(process.create_time()).strftime('%Y-%m-%d %H:%M:%S'),
                'nice': process.nice(),
                'ppid': process.ppid(),
            }

            # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ
            self.root.after(0, lambda: self.show_detail_window(info))

        except Exception as e:
            self.root.after(0, lambda: messagebox.showerror(
                "–û—à–∏–±–∫–∞",
                f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é: {str(e)}"
            ))

    def show_detail_window(self, info):
        """–ü–æ–∫–∞–∑–∞—Ç—å –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π"""
        detail_window = tk.Toplevel(self.root)
        detail_window.title(f"–î–µ—Ç–∞–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞: {info['name']} (PID: {info['pid']})")
        detail_window.geometry("600x500")

        # –î–µ–ª–∞–µ–º –æ–∫–Ω–æ –ø–æ–≤–µ—Ä—Ö –æ—Å–Ω–æ–≤–Ω–æ–≥–æ
        detail_window.transient(self.root)
        detail_window.grab_set()

        # –°–æ–∑–¥–∞–µ–º —Ç–µ–∫—Å—Ç —Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π
        text_frame = ttk.Frame(detail_window, padding="10")
        text_frame.pack(fill=tk.BOTH, expand=True)

        text_widget = scrolledtext.ScrolledText(text_frame, wrap=tk.WORD, font=('Consolas', 10))
        text_widget.pack(fill=tk.BOTH, expand=True)

        # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        details = f"""
{'=' * 60}
–î–ï–¢–ê–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–†–û–¶–ï–°–°–ï
{'=' * 60}

–û–°–ù–û–í–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø:
  PID: {info['pid']}
  –ò–º—è: {info['name']}
  –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π PID: {info['ppid']}
  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {info['username']}
  –ü—É—Ç—å: {info['exe']}

–ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–¨:
  CPU: {info['cpu_percent']:.1f}%
  –ü–∞–º—è—Ç—å: {info['memory_mb']:.1f} MB ({info['memory_percent']:.1f}%)
  –ü–æ—Ç–æ–∫–∏: {info['threads']}
  –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {info['nice']}

–°–û–°–¢–û–Ø–ù–ò–ï:
  –°—Ç–∞—Ç—É—Å: {info['status']}
  –í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞: {info['create_time']}
  –ö–æ–º–∞–Ω–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞: {info['cmdline']}

{'=' * 60}
        """

        text_widget.insert(1.0, details.strip())
        text_widget.config(state=tk.DISABLED)

        # –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è
        ttk.Button(detail_window,
                   text="–ó–∞–∫—Ä—ã—Ç—å",
                   command=detail_window.destroy).pack(pady=10)

    def show_details(self):
        """–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞"""
        selection = self.tree.selection()
        if selection:
            self.show_process_details(None)
        else:
            messagebox.showinfo("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π")

    def manual_update(self):
        """–†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ"""
        if not self.paused:
            self.update_status("–†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ...")
            # –û—á–∏—â–∞–µ–º –∫—ç—à –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            self.processes.clear()

    def toggle_pause(self):
        """–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –ø–∞—É–∑—É"""
        self.paused = not self.paused

        if self.paused:
            self.update_status("–ü–∞—É–∑–∞")
            self.active_label.config(text="–ê–∫—Ç–∏–≤–Ω–æ–µ –æ–∫–Ω–æ: –ü–∞—É–∑–∞")
        else:
            self.update_status("–í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–æ")

    def search_process(self):
        """–ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞"""
        search_window = tk.Toplevel(self.root)
        search_window.title("–ü–æ–∏—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞")
        search_window.geometry("400x300")

        ttk.Label(search_window, text="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ PID:").pack(pady=10)

        search_var = tk.StringVar()
        search_entry = ttk.Entry(search_window, textvariable=search_var, width=30)
        search_entry.pack(pady=10)
        search_entry.focus()

        result_text = scrolledtext.ScrolledText(search_window, height=10, wrap=tk.WORD)
        result_text.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)

        def perform_search():
            query = search_var.get().strip().lower()
            result_text.delete(1.0, tk.END)

            if not query:
                result_text.insert(1.0, "–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å")
                return

            results = []
            for pid, proc in self.processes.items():
                try:
                    if (query in str(pid) or
                            query in proc['name'].lower() or
                            (proc.get('username') and query in proc['username'].lower())):
                        results.append(f"{pid:>6} | {proc['name']}")
                except:
                    continue

            if results:
                result_text.insert(1.0, f"–ù–∞–π–¥–µ–Ω–æ: {len(results)}\n\n")
                result_text.insert(tk.END, "\n".join(results))
            else:
                result_text.insert(1.0, "–ù–µ –Ω–∞–π–¥–µ–Ω–æ")

        ttk.Button(search_window, text="üîç –ù–∞–π—Ç–∏", command=perform_search).pack(pady=10)
        search_entry.bind('<Return>', lambda e: perform_search())

    def kill_process(self):
        """–ó–∞–≤–µ—Ä—à–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å"""
        selection = self.tree.selection()
        if not selection:
            messagebox.showwarning("–í–Ω–∏–º–∞–Ω–∏–µ", "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å")
            return

        item = self.tree.item(selection[0])
        pid = item['values'][0]
        name = item['values'][1]

        # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        if not messagebox.askyesno("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ",
                                   f"–ó–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å?\nPID: {pid}\n–ò–º—è: {name}"):
            return

        # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
        thread = threading.Thread(
            target=self.terminate_process,
            args=(pid, name),
            daemon=True
        )
        thread.start()

    def terminate_process(self, pid, name):
        """–ó–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å (–≤ —Ñ–æ–Ω–æ–≤–æ–º –ø–æ—Ç–æ–∫–µ)"""
        try:
            process = psutil.Process(pid)
            process.terminate()

            # –°–æ–æ–±—â–∞–µ–º –æ–± —É—Å–ø–µ—Ö–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ
            self.root.after(0, lambda: messagebox.showinfo(
                "–£—Å–ø–µ—Ö",
                f"–ü—Ä–æ—Ü–µ—Å—Å '{name}' –∑–∞–≤–µ—Ä—à–µ–Ω"
            ))

        except Exception as e:
            self.root.after(0, lambda: messagebox.showerror(
                "–û—à–∏–±–∫–∞",
                f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å: {str(e)}"
            ))

    def change_interval(self, event=None):
        """–ò–∑–º–µ–Ω–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"""
        try:
            new_interval = int(self.interval_var.get())
            if 100 <= new_interval <= 5000:
                self.update_interval = new_interval
                self.update_status(f"–ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: {new_interval} –º—Å")
        except ValueError:
            messagebox.showerror("–û—à–∏–±–∫–∞", "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª")

    def on_closing(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞"""
        self.running = False
        self.paused = True

        # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ—Ç–æ–∫–æ–≤
        time.sleep(0.2)

        # –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
        self.root.destroy()


def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ Windows
    if sys.platform != 'win32':
        print("–≠—Ç–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ Windows")
        return

    # –°–æ–∑–¥–∞–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫ GUI
    root = tk.Tk()

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∫–æ–Ω–∫—É (–µ—Å–ª–∏ –µ—Å—Ç—å)
    try:
        import ctypes
        myappid = 'com.tron.processmonitor.1.0'
        ctypes.windll.shell32.SetCurrentProcessExplicitAppUserModelID(myappid)
    except:
        pass

    # –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    app = ProcessMonitorGUI(root)

    # –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –æ–∫–Ω–æ
    root.update_idletasks()
    width = root.winfo_width()
    height = root.winfo_height()
    x = (root.winfo_screenwidth() // 2) - (width // 2)
    y = (root.winfo_screenheight() // 2) - (height // 2)
    root.geometry(f'{width}x{height}+{x}+{y}')

    # –ó–∞–ø—É—Å–∫–∞–µ–º –≥–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª
    root.mainloop()


if __name__ == "__main__":
    main()
